---
title: "PanOS Architecture and Design"
description: "Deep dive into PanOS internals, boot process, filesystem structure, and system design"
author: "PanOS Development Team"
version: "1.0.0"
lastUpdated: "2024-02-16"
difficulty: "advanced"
estimatedReadTime: "25 min"
section: "Architecture"
order: 6
keywords: ["architecture", "design", "internals", "boot", "filesystem", "kernel", "initramfs"]
slug: "architecture"
---

# PanOS Architecture and Design

## Overview

PanOS is a minimal Linux system designed with a specific purpose: **run JavaScript with full Unix tooling**. The architecture reflects this:

```
Hardware/QEMU
    â†“
BIOS/UEFI
    â†“
Bootloader (GRUB or kernel direct boot)
    â†“
Linux Kernel 6.6.15
    â†“
Initramfs (compressed filesystem)
    â†“
init script (/init)
    â†“
Shell (/bin/sh)
    â†“
User applications (Node.js, npm, etc.)
```

## Component Architecture

### 1. Linux Kernel (6.6.15)

**Purpose**: Core operating system kernel

**Configuration**: Minimal build with only essential features

**Key Features Enabled**:
```
âœ“ x86_64 architecture
âœ“ SMP (multi-processor support)
âœ“ Serial 8250 console (for QEMU/serial debugging)
âœ“ Virtual filesystem (procfs, sysfs, devtmpfs)
âœ“ EXT4 filesystem support
âœ“ Initramfs/initrd support (BLK_DEV_INITRD)
âœ“ VIRTIO virtualization (for QEMU)
âœ“ Networking (TCP/IP, DHCP)
âœ“ Essential device drivers
```

**Key Features Disabled**:
```
âœ— GPU/graphics drivers
âœ— Audio subsystem
âœ— Most network drivers (only VIRTIO used)
âœ— X.org / Wayland
âœ— Unnecessary filesystems
```

**Size**: 3.3 MB (compressed)

**Boot Time**: ~1-2 seconds

### 2. Busybox

**Purpose**: Complete Unix userspace environment

**What it provides**:
- Shell (`sh`)
- 300+ Unix commands
- Filesystem tools (ls, cp, mv, rm, find)
- Text processing (sed, awk, grep)
- Process management (ps, kill, jobs)
- Network tools (ping, ifconfig, wget, ssh)
- System utilities (mount, umount, fsck)

**How it works**:
- Single binary (`/bin/busybox`) 
- All commands are symlinks pointing to busybox
- Busybox determines which command to run by checking how it was invoked

**Example**:
```
/bin/ls -> /bin/busybox
/bin/cat -> /bin/busybox
/bin/grep -> /bin/busybox

When user runs 'ls', busybox is invoked and
checks argv[0] to see it was called as 'ls'
```

**Size**: ~5 MB uncompressed

### 3. Node.js Runtime

**Purpose**: JavaScript execution engine

**Version**: v24.0.0

**What's included**:
- V8 JavaScript engine
- Node.js standard library
- Native module bindings
- Event loop
- File system access
- Networking
- Module system (require/import)

**Size**: ~50 MB uncompressed

**Integration**:
- Located at `/bin/node`
- npm at `/bin/npm`
- Node modules at `/node_modules`
- Can be invoked like any Unix tool

### 4. Init System

**Purpose**: Initialize and manage system startup

**Implementation**: Simple shell script (`/init`)

**Does the following**:
1. Mount essential filesystems:
   - `proc` â†’ process information
   - `sysfs` â†’ system information
   - `devtmpfs` â†’ device files
   - `tmpfs` â†’ temporary files in RAM

2. Create essential device files:
   - `/dev/console` (serial console)
   - `/dev/tty` (terminal)
   - `/dev/null` (null device)
   - `/dev/zero` (zero device)

3. Print welcome banner

4. Start shell (`/bin/sh`)

**Code flow**:
```bash
#!/bin/busybox sh
exec 2>&1                           # Redirect stderr to stdout

mount -t proc proc /proc            # Mount /proc
mount -t sysfs sysfs /sys           # Mount /sys
mount -t devtmpfs devtmpfs /dev     # Mount /dev
mount -t tmpfs tmpfs /tmp           # Mount /tmp

mknod /dev/console c 5 1            # Create console device
mknod /dev/tty c 5 0                # Create tty device
mknod /dev/null c 1 3               # Create null device

echo "PanOS System Ready!"
exec /bin/sh                        # Start shell (PID 1)
```

## Filesystem Structure

```
/                           # Root directory
â”œâ”€â”€ init                    # Boot script (executable)
â”œâ”€â”€ bin/                    # User-facing binaries
â”‚   â”œâ”€â”€ busybox            # Main executable (7 MB static binary)
â”‚   â”œâ”€â”€ sh, ls, cat, ...   # Symlinks to busybox (330 total)
â”‚   â”œâ”€â”€ node               # Node.js runtime
â”‚   â”œâ”€â”€ npm                # NPM package manager
â”‚   â””â”€â”€ npx                # NPM executor
â”œâ”€â”€ sbin/                   # System binaries
â”‚   â”œâ”€â”€ init               # System init (usually /init)
â”‚   â”œâ”€â”€ halt               # System shutdown
â”‚   â””â”€â”€ reboot             # System reboot
â”œâ”€â”€ lib/                    # System libraries
â”‚   â”œâ”€â”€ libc.musl.so.1     # C runtime library (musl)
â”‚   â”œâ”€â”€ libcrypto.so       # OpenSSL crypto
â”‚   â”œâ”€â”€ libz.so            # Compression library
â”‚   â””â”€â”€ ... (other shared libraries)
â”œâ”€â”€ proc/                   # Virtual filesystem - process info
â”‚   â”œâ”€â”€ cpuinfo            # CPU information
â”‚   â”œâ”€â”€ meminfo            # Memory information
â”‚   â””â”€â”€ ... (kernel generated, mounted at runtime)
â”œâ”€â”€ sys/                    # Virtual filesystem - system info
â”‚   â”œâ”€â”€ class/             # Device classes
â”‚   â”œâ”€â”€ devices/           # Devices
â”‚   â””â”€â”€ ... (kernel generated, mounted at runtime)
â”œâ”€â”€ tmp/                    # Temporary directory (RAM-backed)
â”‚   â””â”€â”€ (user files)
â”œâ”€â”€ root/                   # Root user home directory
â”‚   â”œâ”€â”€ boot.js            # Boot script (if custom)
â”‚   â””â”€â”€ .bashrc            # Shell configuration
â”œâ”€â”€ var/                    # Variable data
â”‚   â”œâ”€â”€ lib/               # Application data
â”‚   â”œâ”€â”€ log/               # Log files
â”‚   â””â”€â”€ tmp/               # Temporary files
â”œâ”€â”€ etc/                    # Configuration
â”‚   â”œâ”€â”€ hostname           # System hostname
â”‚   â”œâ”€â”€ passwd             # User database
â”‚   â””â”€â”€ fstab              # Filesystem table
â””â”€â”€ node_modules/          # NPM global packages
    â”œâ”€â”€ npm@10.7.0/
    â”œâ”€â”€ ... (installed packages)
```

## Boot Sequence

### Phase 1: Machine Boot (Hardware)

1. **Power On** â†’ CPU resets, loads BIOS
2. **BIOS** â†’ Runs power-on self-test, initializes hardware
3. **Bootloader** â†’ BIOS copies bootloader to memory and jumps to it

### Phase 2: Bootloader (GRUB or Direct)

**Option A: GRUB ISO Boot**
- GRUB runs (shows menu if available)
- User selects "PanOS" entry
- GRUB loads kernel into memory
- GRUB loads initramfs into memory
- GRUB hands control to kernel with memory addresses

**Option B: Direct Kernel Boot** (./2-run.sh method)
- QEMU directly loads vmlinuz at 0x1000000
- QEMU directly loads initramfs.cpio after kernel
- QEMU passes memory info to kernel
- QEMU jumps to kernel entry point

### Phase 3: Kernel Initialization (1-2 seconds)

1. **Kernel setup**:
   - Decompresses vmlinuz
   - Sets up memory management
   - Initializes CPU features
   - Parses command line parameters

2. **Hardware initialization**:
   - Detects CPU, APIC, IOMMU
   - Initializes I/O subsystems
   - Loads compiled-in drivers

3. **Filesystem setup**:
   - Mounts rootfs (initramfs as temporary root)
   - Initializes /dev, /proc, /sys

4. **Kernel messages** (visible on console):
   ```
   [    0.000000] Linux version 6.6.15...
   [    0.000000] Command line: console=ttyS0
   [    0.050000] Memory: 2M/2048M
   [    0.100000] Dentry cache hash table entries...
   ```

### Phase 4: Init Script Execution (~500ms)

1. **Init starts** (first userspace process, PID 1):
   ```bash
   # /init runs as PID 1
   ```

2. **Mounts filesystems**:
   ```bash
   mount -t proc proc /proc
   mount -t sysfs sysfs /sys
   mount -t devtmpfs devtmpfs /dev
   mount -t tmpfs tmpfs /tmp
   ```

3. **Creates device files**:
   ```bash
   mknod /dev/console c 5 1
   mknod /dev/tty c 5 0
   ```

4. **Prints welcome message**:
   ```
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘        ğŸš€ PanOS - Shell Ready         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ```

5. **Execs shell**:
   ```bash
   exec /bin/sh    # Replace init process with shell
   ```

### Phase 5: Shell Ready (~3-5 seconds total)

User gets prompt:
```
/ #
```

Can run commands immediately.

## Memory Layout

### At Boot Time

```
0x0000 - 0x1000         Reserved (BIOS)
0x1000 - 0x400000       Kernel code
0x400000 - 0x500000     Kernel data
0x500000 - 0x1000000    Free memory
0x1000000+              Initramfs (loaded here by bootloader)
```

### After Init Mounts

```
Physical Memory (2048 MB example)
â”œâ”€â”€ Kernel            (~10 MB)
â”œâ”€â”€ Initramfs cache   (~100 MB)
â”œâ”€â”€ Filesystem cache  (~200 MB)
â”œâ”€â”€ Applications      (variable)
â””â”€â”€ Free memory       (~1700 MB available)
```

### Virtual Memory Maps

Each process has isolated memory:

```
Per-process Virtual Memory (64-bit x86_64)
0x0000000000000000 - 0x00007fffffffffff  User space
  â”œâ”€â”€ Text (code)
  â”œâ”€â”€ Data (initialized)
  â”œâ”€â”€ BSS (uninitialized)
  â”œâ”€â”€ Heap (grows up)
  â”œâ”€â”€ Stack (grows down)
  â””â”€â”€ Mmap region

0xffff800000000000 - 0xffffffffffffffff  Kernel space
  â”œâ”€â”€ Kernel code
  â”œâ”€â”€ Kernel data
  â”œâ”€â”€ IDT/GDT/LDT
  â””â”€â”€ Page tables
```

## Process Tree

### At Startup

```
PID 1: /init (shell script)
â””â”€ PID 1: /bin/sh (after exec)
    â”œâ”€ PID X: user command 1
    â”œâ”€ PID Y: user command 2
    â””â”€ ... (each command started by shell)
```

### During Node.js Session

```
PID 1: /bin/sh (shell)
â”œâ”€ PID 2: node (Node.js process)
â”‚  â””â”€ PID 3,4,5... (child threads/workers)
â”œâ”€ PID 6: ls (user command)
â””â”€ PID 7: cat (user command)
```

**Important**: PID 1 is special - if it exits, system dies.

## Initramfs Structure

The initramfs.cpio archive contains:

```
Compression: gzip
Format: cpio newc
Total size: 142 MB (compressed) / 500 MB+ (uncompressed)

Contents:
- Entire /bin directory (busybox + symlinks)
- Entire /lib directory (libraries)
- Entire /sbin directory  
- Entire /node_modules directory
- /init script
- All required device nodes
- All required directories
```

**Mounted as**:
- Initial root filesystem at boot
- Accessible at `/` during runtime
- Read-only overlay (or writable depending on configuration)

## QEMU Integration

### QEMU Boot Sequence

1. **QEMU starts** with virtual hardware:
   - Virtual CPU (emulated x86_64)
   - Virtual RAM (configurable, default 2 GB)
   - Virtual disk (none, uses initramfs)
   - Virtual serial port (kernel output)
   - Virtual ethernet (network access)

2. **QEMU loads kernel**:
   - Reads vmlinuz file
   - Decompresses (already in bzImage format)
   - Places in memory at 0x1000000

3. **QEMU loads initramfs**:
   - Reads initramfs.cpio file
   - Places in memory after kernel
   - Passes address to kernel via bootloader

4. **QEMU configures bootloader parameters**:
   - Command line: `console=ttyS0`
   - Memory size: configurable (1-8 GB)
   - CPU count: configurable (1-N)

5. **QEMU jumps to kernel entry point**:
   - CPU executes kernel initialization code
   - Kernel boots, runs init, shell starts

### Serial Console

All output goes to virtual serial port 0 (/dev/ttyS0):

```bash
# Inside PanOS
echo "test" > /dev/ttyS0    # Sends to QEMU's stdout

# In QEMU output
test
```

This is how kernel messages and shell output appear:

```
QEMU emulator version 7.2.0
[    0.000000] Linux version 6.6.15...
/ #                          # Shell prompt
```

### Network in QEMU

Virtual ethernet card provides:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PanOS (inside QEMU)                           â”‚
â”‚                                                â”‚
â”‚  eth0: 10.0.2.15/24   (assigned by DHCP)     â”‚
â”‚  Default gateway: 10.0.2.2 (QEMU's gateway)  â”‚
â”‚  DNS: 10.0.2.3 (QEMU's resolver)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
        Virtual network
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host machine                                    â”‚
â”‚                                                â”‚
â”‚ Can access 10.0.2.0/24 from QEMU              â”‚
â”‚ QEMU forwards ports using -netdev user params â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Port forwarding examples:

```bash
# Forward port 8080
-netdev user,hostfwd=tcp::8080-:8080

# Forward SSH (port 22)
-netdev user,hostfwd=tcp::2222-:22

# Inside PanOS
# if you run server on :8080
# it's accessible from host on localhost:8080
```

## System Resource Usage

### Kernel Memory

```
Kernel Text:    1.2 MB (code)
Kernel Data:    2.1 MB (data)
Page tables:    1.5 MB
Caches:         ~100 MB (can grow)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:          ~104 MB baseline
```

### Busybox + Node.js

```
Busybox:        7 MB
Node.js:        50 MB
Libraries:      ~30 MB
Node modules:   ~50 MB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:          ~137 MB (compressed ~135 MB in initramfs)
```

### Runtime Memory (2 GB allocated)

```
Kernel:         104 MB
Busybox:        7 MB (minimal when idle)
Shell:          1 MB
Available:      ~1880 MB free
```

Scales down with less configured RAM.

## Process Lifecycle

### Process Creation

```bash
# User types command
/ # npm install express

# Shell (PID 1) forks:
1. fork() â†’ creates child process
2. execve() â†’ loads npm binary
3. npm runs as child

PID 1: /bin/sh (waiting)
â””â”€ PID X: npm process (executing)
```

### Process Termination

```bash
# npm install completes
# Process calls exit()
# Kernel marks process as zombie
# Shell (parent) receives SIGCHLD
# Shell reaps process and prints prompt

/ # 
```

## Customization Points

You can modify:

1. **Kernel Configuration** â†’ Edit `1-build.sh` .config
2. **Init Script** â†’ Edit rootfs init script
3. **Installed Tools** â†’ Modify Busybox installation
4. **Node.js Version** â†’ Change download URL
5. **Boot Parameters** â†’ Edit GRUB module or kernel append

See [10-advanced.mdx](./10-advanced.mdx) for details.

## Performance Characteristics

| Metric | Value | Notes |
|--------|-------|-------|
| **Boot Time** | 3-5s | Until shell prompt |
| **RAM Overhead** | 100-150 MB | Kernel + base system |
| **Disk Space** | 160 MB | ISO size |
| **npm install** | 30-60s | For medium packages |
| **Node startup** | ~100ms | Per process |
| **Context switch** | ~1Âµs | System dependent |

## Next Steps

- **Learn Node.js Integration**: Read [07-nodejs-integration.mdx](./07-nodejs-integration.mdx)
- **Troubleshoot Issues**: Read [08-troubleshooting.mdx](./08-troubleshooting.mdx)
- **Advanced Customization**: Read [10-advanced.mdx](./10-advanced.mdx)

---

**Previous**: [05-running.mdx](./05-running.mdx)  
**Next**: [07-nodejs-integration.mdx](./07-nodejs-integration.mdx)
